#!/bin/sh

OPKG_DEST=ram
RAM_DIR="$(awk '$1 == "dest" && $2 == "'"$OPKG_DEST"'" { gsub("/+$", "", $3); print $3 }' /etc/opkg.conf)"
LISTS_DIR="$(awk '$1 == "lists_dir" { gsub("/+$", "", $3); print $3 }' /etc/opkg.conf)"

if ! [ -d "$RAM_DIR" ]; then
  mkdir -p "$RAM_DIR"
  [ -d "$RAM_DIR/tmp" ] || ln -s /tmp "$RAM_DIR"/tmp
  [ -d "$RAM_DIR/var" ] || ln -s /tmp "$RAM_DIR"/var
fi

if ! [ -d "$LISTS_DIR" ]; then
  mkdir -p "$LISTS_DIR"
fi

_X() {
  ( set -x
    "$@"
  )
}

usage() {
cat >&2 << EOF
usage: wrapper arount opkg, use opkg for more help
  $0 list | status | install | remove | enable | disable | update | files | search | query
EOF
}

# assume mapping $src <-> $dst with
#    $src <-> $prefix/$src = $dst
install_files_mapper() {
  local op=
  local src="$1"
  local dst="${src#$RAM_DIR}"
  case "$dst" in
  # ignores
    /lib/upgrade/* ) # NOP
      op=cp
      continue
      ;;
  # 2-dirs deep
    /www/luci-static/* )
      tmp="${dst#/*/*/}"
      dst="${dst%/$tmp}"; dst="${dst%/}"
      op=ln
      ;;
  # 3-dirs deep
    /usr/lib/collectd/* | \
    /usr/share/collectd/* | \
    /usr/share/terminfo/* )
      tmp="${dst#/*/*/*/}"
      dst="${dst%/$tmp}"; dst="${dst%/}"
      op=ln
      ;;
  # 4-dirs deep
    /usr/lib/lua/luci/* )
      tmp="${dst#/*/*/*/*/}"
      dst="${dst%/$tmp}"; dst="${dst%/}"
      op=ln
      ;;
    /etc/init.d/* )
      op=ln
      ;;
    /etc/* )
      op=cp
      ;;
    /lib/* | /bin/* | /sbin/* | /www/* | \
    /usr/lib/* | /usr/bin/* | /usr/sbin/* | /usr/share/* )
      op=ln
      ;;
    * )
      echo "E: unknown destination $dst, SKIP" >&2
      continue
      ;;
    esac

    echo "$op:$dst"
}

ensure_lists_updated() {
  if ! ls "$LISTS_DIR"/* 2> /dev/null 1>&2; then
    echo "I: no opkg package lists, we need an update"
    opkg update > /dev/null
    echo
  fi >&2
}

tac() {
  local line
  if read line; then
    tac
    echo "$line"
  fi
}

status() {
  opkg -o "$RAM_DIR" list
}

install() {
  ensure_lists_updated

  local F=
  if [ "$1" = -F ]; then
    F=-F
    shift
  fi

  for pkg in "$@"; do
    opkg --noaction -d "$OPKG_DEST" install "$pkg" | awk '$1 == "Installing" { print $2 }' | tac | while read pkg; do
      if opkg -d "$OPKG_DEST" install "$pkg"; then :
        enable $F "$pkg"
        rm -f "$RAM_DIR/usr/lib/opkg/info/"*.postinst
      fi
    done
  done
}

remove() {
  local pkg pkgs
  local info=

  if [ "$1" = -a ]; then
    pkgs="$(status | cut -f 1 -d ' ')"
    remove $pkgs
    return $?
  fi

  for pkg in "$@"; do
    info="$info $pkg.list"
  done

  # try to get packges in configure order
  pkgs="$( cd "$RAM_DIR/usr/lib/opkg/info"; ls -t $info 2> /dev/null | sed -re 's/[.][^.]+$//')"

  for pkg in $pkgs; do
    disable "$pkg"
    { 3>&1 1>&2 2>&3 3>&- \
      opkg -d "$OPKG_DEST" remove "$pkg" | \
        sed -e "/^cat: can't open / d"
    } 3>&1 1>&2 2>&3 3>&-
  done
}

files() {
  opkg -d "$OPKG_DEST" files "$@"
}

enable() {
  local p files src dst rlink dir op tmp
  local F=
  if [ "$1" = -F ]; then
    F=-f
    shift
  fi
  for p in "$@"; do
    files "$p" | while read src; do
      [ -f "$src" ] || continue

      # assume mapping $src <-> $dst with
      #    $src <-> $prefix/$src = $dst
      op="$(install_files_mapper "$src")"
      dst="${op#*:}"
      op="${op%:$dst}"
      src="$RAM_DIR/${dst#/}"
      #echo "$op $dst <- $src"; continue

      if [ -L "$dst" ]; then
        rlink="$(readlink "$dst")"
        [ "$rlink" = "$src" ] && \
          continue
      fi

      if [ -z "$F" ] && [ -f "$dst" ]; then
        echo "I: would install $dst, but file already exists."
        continue
      fi

      dir="${dst%/*}"
      mkdir -p "$dir"

      case "$op" in
        ln )
          opfmt=" LN$F "
          ln -s $F "$src" "$dst"
          ;;
	cp )
          opfmt=" CP$F "
          cp -a $F "$src" "$dst"
          ;;
        * )
          echo "E: unknown op $op src=$src dst=$dst, SKIP" >&2
          continue
          ;;
      esac

      [ -n "$opfmt" ] && \
	echo "$opfmt $dst"

    done
  done
}

disable() {
  local p files src dst rlink dir
  for p in "$@"; do
    files "$p" | sort -r | while read src; do
      [ -f "$src" ] || continue

      # assume mapping $src <-> $dst with
      #    $src <-> $prefix/$src = $dst
      op="$(install_files_mapper "$src")"
      dst="${op#*:}"
      op="${op%:$dst}"
      src="$RAM_DIR/${dst#/}"
      dst="${src#$RAM_DIR}"
      #echo "$op $dst <- $src"; continue

      if [ -f "$dst" ]; then :
      elif [ -d "$dst" ]; then :
      elif [ -L "$dst" ]; then :
      else
        continue
      fi

      if   [ -L "$dst" ]; then
        if [ -d "$dst" ] && ls "$dst"/* 2> /dev/null 1>&2; then
          op=nop
        else
          rlink="$(readlink "$dst")"
          [ "$rlink" = "$src" ] && \
            op=rm
        fi
      elif [ -d "$src" ]; then
        op=rmdir
      elif [ -f "$dst" ]; then
        if [ -x "$(which cmp)" ] && cmp "$src" "$dst" > /dev/null; then
          op=rm
          echo "I: $dst is a file, without a diff, rm."
        else
          op=nop
          echo "I: $dst is a file, modified, KEEP"
        fi
      fi

      case "$op" in
        nop)
	  opfmt=
          ;;
        rmdir )
          opfmt=" RMDIR "
          rmdir "$d" 2> /dev/null
          ;;
	rm )
          opfmt=" RM    "
          rm -f "$dst"
          ;;
        * )
          echo "E: unknown op $op src=$src dst=$dst, SKIP" >&2
          continue
          ;;
      esac

      [ -n "$opfmt" ] && \
	echo "$opfmt $dst"

    done
  done
}

query() {
  ensure_lists_updated
  opkg list | grep -i "$*"
}

cmd="$1"
[ $# -gt 0 ] && shift

case "$cmd" in
  up | update ) opkg update ;;
  l | ls | li | list )  opkg list ;;

  i | ins | install )  install "$@" ;;
  r | rm | remove )        remove  "$@" ;;
  s | st  | status  )  status  "$@" ;;
  e | en  | enable  )  enable  "$@" ;;
  d | di  | disable )  disable "$@" ;;
  f | files )          files   "$@" ;;
  q | query | search ) query   "$@" ;;

  "" | help | -h | * ) usage ;;
esac

cd /tmp
find . -name "opkg-??????" -type d | while read f; do
    _X rm -rf "$f"
  done
