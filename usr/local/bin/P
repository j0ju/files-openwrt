#!/bin/sh

OPKG_DEST=ram
RAM_DIR="$(grep "dest $OPKG_DEST" /etc/opkg.conf | cut -f 3 -d " " )"
RAM_DIR="${RAM_DIR%/}"

if ! [ -d "$RAM_DIR" ]; then
  mkdir -p "$RAM_DIR"
  [ -d "$RAM_DIR/tmp" ] || ln -s /tmp "$RAM_DIR"/tmp
  [ -d "$RAM_DIR/var" ] || ln -s /tmp "$RAM_DIR"/var
fi

_X() {
  ( set -x
    "$@"
  )
}

usage() {
cat >&2 << EOF
usage: wrapper arount opkg, use opkg for more help
  $0 list | status | install | remove | enable | disable | update | files
EOF
}

status() {
  opkg -o "$RAM_DIR" list
}

install() {
  local F=
  if [ "$1" = -F ]; then
    F=-F
    shift
  fi
  opkg --noaction -d "$OPKG_DEST" install "$@" | awk '$1 == "Installing" { print $2 }' | sort -r | while read pkg; do
    if $_X opkg -d "$OPKG_DEST" install "$pkg"; then :
      enable $F "$pkg"
      rm -f "$RAM_DIR/usr/lib/opkg/info/"*.postinst
    fi
  done
}

remove() {
  local pkg info=

  for pkg in "$@"; do
    info="$info $pkg.list"
  done

  # try to get packges in configure order
  local pkgs="$( cd "$RAM_DIR/usr/lib/opkg/info"; ls -t $info 2> /dev/null | sed -re 's/[.][^.]+$//')"

  for pkg in "$@"; do
    disable "$pkg"
    { 3>&1 1>&2 2>&3 3>&- \
      _X opkg -d "$OPKG_DEST" remove "$pkg" | \
        sed -e "/^cat: can't open / d"
    } 3>&1 1>&2 2>&3 3>&-
  done
}

files() {
  opkg -d "$OPKG_DEST" files "$@"
}

enable() {
  local p files src dst rlink dir
  local F=
  if [ "$1" = -F ]; then
    F=-f
    shift
  fi
  for p in "$@"; do
    files "$p" | while read src; do
      [ -f "$src" ] || continue
      dst="${src#$RAM_DIR}"

      if [ -L "$dst" ]; then
        rlink="$(readlink "$dst")"
        [ "$rlink" = "$src" ] && \
          continue
      fi

      if [ -n "$F" ] && [ -f "$dst" ]; then
        echo "I: would install $dst, but file already exists."
        continue
      fi

      dir="${dst%/*}"
      mkdir -p "$dir"

      case "$dst" in
        /lib/upgrade/* )
          # NOP
          ;;
        /etc/* )
          local OP="CP$F "
          cp -a $F "$src" "$dst"
          ;;
        * )
          local OP="LN$F "
          ln -s $F "$src" "$dst"
          ;;
      esac
      echo "$OP $dst"

    done
  done
}

disable() {
  local p files src dst rlink dir
  for p in "$@"; do
    files "$p" | sort -r | while read src; do
      [ -f "$src" ] || continue
      dst="${src#$RAM_DIR}"

      if   [ -L "$dst" ]; then
        rlink="$(readlink "$dst")"
        [ "$rlink" = "$src" ] && \
          _X rm -f "$dst"
	  continue
      elif [ -d "$src" ]; then
	rmdir "$d" 2> /dev/null
      elif [ -f "$dst" ]; then
        echo "I: would uninstall $dst, but it is not linked."
        continue
      fi
    done
  done
}

cmd="$1"
[ $# -gt 0 ] && shift

case "$cmd" in
  up | update ) opkg update ;;
  l | ls | li | list )  opkg list ;;

  i | ins | install ) install "$@" ;;
  rm | remove )       remove  "$@" ;;
  s | st  | status  ) status  "$@" ;;
  e | en  | enable  ) enable  "$@" ;;
  d | di  | disable ) disable "$@" ;;
  f | files )         files   "$@" ;;

  "" | help | -h | * ) usage ;;
esac

cd /tmp
find . -name "opkg-??????" -type d | while read f; do
    _X rm -rf "$f"
  done
